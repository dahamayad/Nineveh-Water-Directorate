<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رسم منطقة أو معلم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: white;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #4facfe;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .tool-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tool-group label {
            display: block;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }

        .tool-btn i {
            font-size: 1.2rem;
        }

        .tool-btn:hover {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: #3498db;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }

        input[type="color"] {
            opacity: 0;
            position: absolute;
            pointer-events: none;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            text-align: center;
            color: #4facfe;
            font-weight: bold;
            margin-top: 5px;
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        select option {
            background: #1e293b;
            color: white;
        }

        .existing-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            font-size: 12px;
        }

        /* Modern Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            animation: slideInRight 0.4s ease-out;
            min-width: 300px;
            max-width: 400px;
        }

        .toast.success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .toast.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .toast.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .toast i {
            font-size: 24px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Modern Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-content {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: scaleIn 0.3s ease-out;
        }

        .confirm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .confirm-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 15px;
        }

        .confirm-message {
            color: #94a3b8;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .confirm-yes {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .confirm-no {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .confirm-yes:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .confirm-no:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100%;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            }

            .sidebar.active {
                left: 0;
            }

            .map-container {
                width: 100%;
            }

            .sidebar-toggle {
                display: flex !important;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .tool-buttons {
                grid-template-columns: repeat(3, 1fr);
            }

            .toast {
                right: 10px;
                left: 10px;
                min-width: auto;
                top: 70px;
            }
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .sidebar-toggle:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="confirm-title" id="confirmTitle">تأكيد العملية</div>
            <div class="confirm-message" id="confirmMessage">هل أنت متأكد؟</div>
            <div class="confirm-buttons">
                <button class="confirm-no" id="confirmNo">إلغاء</button>
                <button class="confirm-yes" id="confirmYes">تأكيد</button>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <h3><i class="fas fa-tools"></i> أدوات الرسم</h3>

        <!-- Area Selection Dropdown -->
        <div class="tool-group">
            <label>اختر منطقة للتعديل</label>

            <select id="areaSelect">
                <option value="">-- جديد --</option>
            </select>
        </div>

        <!-- Drawing Tools -->
        <div class="tool-group">
            <label>نوع الرسم</label>
            <div class="tool-buttons">
                <button class="tool-btn" id="drawPointBtn">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>نقطة</span>
                </button>
                <button class="tool-btn" id="drawLineBtn">
                    <i class="fas fa-route"></i>
                    <span>خط</span>
                </button>
                <button class="tool-btn" id="drawPolygonBtn">
                    <i class="fas fa-draw-polygon"></i>
                    <span>مضلع</span>
                </button>
            </div>
        </div>

        <!-- Style Tools -->
        <div class="tool-group">
            <label>خصائص الرسم</label>
            <div class="color-picker-group">
                <div class="color-preview" id="lineColorPreview" style="background-color: #3388ff;"></div>
                <input type="color" id="lineColor" value="#3388ff">
                <span style="font-size: 0.9rem;">لون الخط</span>
            </div>
            <div class="color-picker-group" style="margin-top: 10px;">
                <div class="color-preview" id="fillColorPreview" style="background-color: #3388ff;"></div>
                <input type="color" id="fillColor" value="#3388ff">
                <span style="font-size: 0.9rem;">لون التعبئة</span>
            </div>
            <div style="margin-top: 15px;">
                <label>سمك الخط: <span id="lineWidthValue" class="range-value">3 px</span></label>
                <input type="range" id="lineWidth" min="1" max="10" value="3">
            </div>
        </div>

        <!-- Map Toggle Button -->
        <div class="tool-group">
            <label>نوع الخريطة</label>
            <button class="btn btn-primary" id="toggleMapTypeBtn" style="width:100%">
                <i class="fas fa-layer-group"></i> تبديل نوع الخريطة
            </button>
        </div>

        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-success" id="saveBtn">
                <i class="fas fa-save"></i> حفظ الرسم
            </button>
            <button class="btn btn-warning" id="clearDrawingBtn">
                <i class="fas fa-eraser"></i> مسح الرسم
            </button>
            <button class="btn btn-danger" id="cancelBtn">
                <i class="fas fa-times"></i> إلغاء
            </button>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let drawLayer;
        let drawPoints = [];
        let drawMode = null;
        let currentLineColor = '#3388ff';
        let currentLineWidth = 3;
        let currentFillColor = '#3388ff';
        let editingAreaId = null;
        let googleLayer, hybridLayer;
        const DEFAULT_CENTER = [36.3489, 43.1577];

        function populateAreaSelect() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">-- جديد --</option>';
            const areas = JSON.parse(localStorage.getItem('waterAreas')) || [];

            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                select.appendChild(option);
            });
        }

        document.getElementById('areaSelect').onchange = function () {
            const areaId = Number(this.value);
            if (!areaId) {
                editingAreaId = null;
                if (drawLayer) map.removeLayer(drawLayer);
                drawPoints = [];
                return;
            }

            const areas = JSON.parse(localStorage.getItem('waterAreas')) || [];
            const area = areas.find(a => a.id === areaId);

            if (!area) return;

            editingAreaId = areaId;

            if (drawLayer) map.removeLayer(drawLayer);
            drawPoints = [];

            if (area.geojson) {
                const gj = area.geojson;

                if (gj.type === 'Point') {
                    setDrawMode('point');
                    const latlng = L.latLng(gj.coordinates[1], gj.coordinates[0]);
                    drawLayer = L.marker(latlng, { draggable: true }).addTo(map);
                    drawPoints = [latlng];
                    map.setView(latlng, 15);
                } else if (gj.type === 'LineString') {
                    setDrawMode('line');
                    const latlngs = gj.coordinates.map(c => L.latLng(c[1], c[0]));
                    drawLayer = L.polyline(latlngs, {
                        color: currentLineColor,
                        weight: currentLineWidth
                    }).addTo(map);
                    drawPoints = latlngs;
                    map.fitBounds(drawLayer.getBounds());
                } else if (gj.type === 'Polygon') {
                    setDrawMode('polygon');
                    const latlngs = gj.coordinates[0].map(c => L.latLng(c[1], c[0]));
                    drawLayer = L.polygon(latlngs, {
                        color: currentLineColor,
                        weight: currentLineWidth,
                        fillColor: currentFillColor,
                        fillOpacity: 0.3
                    }).addTo(map);
                    drawPoints = latlngs;
                    map.fitBounds(drawLayer.getBounds());
                }
            } else if (area.lat && area.lng) {
                setDrawMode('point');
                const latlng = L.latLng(area.lat, area.lng);
                drawLayer = L.marker(latlng, { draggable: true }).addTo(map);
                drawPoints = [latlng];
                map.setView(latlng, 15);
            }
        };

        function loadExistingAreas() {
            try {
                const areas = JSON.parse(localStorage.getItem('waterAreas')) || [];
                areas.forEach(area => {
                    if (area.geojson) {
                        const gj = area.geojson;
                        if (gj.type === 'Point') {
                            L.marker([gj.coordinates[1], gj.coordinates[0]], { opacity: 0.5 })
                                .bindTooltip(area.name, { permanent: true, direction: 'top', className: 'existing-label' })
                                .addTo(map);
                        } else if (gj.type === 'LineString') {
                            L.polyline(gj.coordinates.map(c => [c[1], c[0]]), { color: '#666', weight: 2, dashArray: '5, 5' })
                                .bindTooltip(area.name, { permanent: true, direction: 'center', className: 'existing-label' })
                                .addTo(map);
                        } else if (gj.type === 'Polygon') {
                            L.polygon(gj.coordinates[0].map(c => [c[1], c[0]]), {
                                color: '#666', weight: 1, fillColor: '#999',
                                fillOpacity: 0.2
                            })
                                .bindTooltip(area.name, { permanent: true, direction: 'center', className: 'existing-label' })
                                .addTo(map);
                        }
                    } else if (area.lat && area.lng) {
                        L.marker([area.lat, area.lng], { opacity: 0.5 })
                            .bindTooltip(area.name, { permanent: true, direction: 'top', className: 'existing-label' })
                            .addTo(map);
                    }
                });
            } catch (e) {
                console.error('Error loading existing areas:', e);
            }
        }

        function saveDraft() {
            if (drawLayer && drawMode) {
                const draft = {
                    mode: drawMode,
                    latlngs: drawMode === 'point' ? drawLayer.getLatLng() : drawLayer.getLatLngs(),
                    editingAreaId: editingAreaId
                };
                localStorage.setItem('drawingDraft', JSON.stringify(draft));
            } else {
                localStorage.removeItem('drawingDraft');
            }
        }

        function loadDraft() {
            const draftStr = localStorage.getItem('drawingDraft');
            if (draftStr) {
                try {
                    const draft = JSON.parse(draftStr);
                    editingAreaId = draft.editingAreaId || null;

                    setDrawMode(draft.mode);
                    if (draft.mode === 'point') {
                        drawLayer = L.marker(draft.latlngs, { draggable: true }).addTo(map);
                        drawPoints = [draft.latlngs];
                    } else if (draft.mode === 'line') {
                        drawLayer = L.polyline(draft.latlngs, {
                            color: currentLineColor,
                            weight: currentLineWidth
                        }).addTo(map);
                        drawPoints = draft.latlngs;
                    } else if (draft.mode === 'polygon') {
                        let points = draft.latlngs;
                        if (Array.isArray(points[0]) && !points[0].lat) {
                            points = points[0];
                        }
                        drawLayer = L.polygon(points, {
                            color: currentLineColor,
                            weight: currentLineWidth,
                            fillColor: currentFillColor,
                            fillOpacity: 0.3
                        }).addTo(map);
                        drawPoints = points;
                    }
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
        }

        function setDrawMode(mode) {
            drawMode = mode;
            if (!editingAreaId) {
                drawPoints = [];
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = null;
            }

            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            if (mode === 'point') document.getElementById('drawPointBtn').classList.add('active');
            if (mode === 'line') document.getElementById('drawLineBtn').classList.add('active');
            if (mode === 'polygon') document.getElementById('drawPolygonBtn').classList.add('active');

            document.getElementById('map').style.cursor = 'crosshair';
        }

        function onMapClick(e) {
            if (!drawMode) return;

            if (drawMode === 'point') {
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = L.marker(e.latlng, { draggable: true }).addTo(map);
                drawPoints = [e.latlng];
            } else if (drawMode === 'line') {
                drawPoints.push(e.latlng);
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = L.polyline(drawPoints, {
                    color: currentLineColor,
                    weight: currentLineWidth
                }).addTo(map);
            } else if (drawMode === 'polygon') {
                drawPoints.push(e.latlng);
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = L.polygon(drawPoints, {
                    color: currentLineColor,
                    weight: currentLineWidth,
                    fillColor: currentFillColor,
                    fillOpacity: 0.3
                }).addTo(map);
            }
        }

        // Color and style controls
        document.getElementById('lineColorPreview').onclick = () => document.getElementById('lineColor').click();
        document.getElementById('lineColor').oninput = (e) => {
            currentLineColor = e.target.value;
            document.getElementById('lineColorPreview').style.backgroundColor = currentLineColor;
            if (drawLayer && drawMode !== 'point') {
                drawLayer.setStyle({ color: currentLineColor });
            }
        };

        document.getElementById('fillColorPreview').onclick = () => document.getElementById('fillColor').click();
        document.getElementById('fillColor').oninput = (e) => {
            currentFillColor = e.target.value;
            document.getElementById('fillColorPreview').style.backgroundColor = currentFillColor;
            if (drawLayer && drawMode === 'polygon') {
                drawLayer.setStyle({ fillColor: currentFillColor });
            }
        };

        document.getElementById('lineWidth').oninput = (e) => {
            currentLineWidth = parseInt(e.target.value);
            document.getElementById('lineWidthValue').textContent = currentLineWidth + ' px';
            if (drawLayer && drawMode !== 'point') {
                drawLayer.setStyle({ weight: currentLineWidth });
            }
        };

        document.getElementById('drawPointBtn').onclick = () => setDrawMode('point');
        document.getElementById('drawLineBtn').onclick = () => setDrawMode('line');
        document.getElementById('drawPolygonBtn').onclick = () => setDrawMode('polygon');

        // Helper for confirmation modal
        function showConfirm(title, message) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                modal.classList.add('show');

                const yesBtn = document.getElementById('confirmYes');
                const noBtn = document.getElementById('confirmNo');

                const cleanup = () => {
                    modal.classList.remove('show');
                    yesBtn.onclick = null;
                    noBtn.onclick = null;
                };

                yesBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };

                noBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        document.getElementById('clearDrawingBtn').onclick = async () => {
            if (await showConfirm('حذف الرسم', 'هل أنت متأكد من حذف الرسم الحالي؟')) {
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = null;
                drawPoints = [];
                localStorage.removeItem('drawingDraft');
                showToast('تم حذف الرسم');
            }
        };

        document.getElementById('saveBtn').onclick = async () => {
            try {
                if (!drawLayer) {
                    showToast('يرجى رسم شكل أولاً', 'error');
                    return;
                }

                if (!await showConfirm('حفظ التغييرات', 'هل تريد حفظ الرسم وإغلاق النافذة؟')) return;

                let geoJSON = null;
                let centerLat, centerLng;

                if (drawMode === 'point') {
                    const ll = drawLayer.getLatLng();
                    geoJSON = { type: 'Point', coordinates: [ll.lng, ll.lat] };
                    centerLat = ll.lat;
                    centerLng = ll.lng;
                } else if (drawMode === 'line') {
                    const lls = drawLayer.getLatLngs();
                    geoJSON = { type: 'LineString', coordinates: lls.map(p => [p.lng, p.lat]) };
                    centerLat = lls[0].lat;
                    centerLng = lls[0].lng;
                } else if (drawMode === 'polygon') {
                    const lls = drawLayer.getLatLngs()[0];
                    geoJSON = { type: 'Polygon', coordinates: [lls.map(p => [p.lng, p.lat])] };
                    centerLat = lls[0].lat;
                    centerLng = lls[0].lng;
                }

                const data = {
                    geoJSON: geoJSON,
                    lat: centerLat,
                    lng: centerLng,
                    editingAreaId: editingAreaId
                };

                if (editingAreaId) {
                    const areas = JSON.parse(localStorage.getItem('waterAreas')) || [];
                    const areaIndex = areas.findIndex(a => a.id === editingAreaId);

                    if (areaIndex !== -1) {
                        areas[areaIndex].geojson = geoJSON;
                        areas[areaIndex].lat = centerLat;
                        areas[areaIndex].lng = centerLng;
                        localStorage.setItem('waterAreas', JSON.stringify(areas));

                        showToast('تم تحديث المنطقة بنجاح');
                        localStorage.removeItem('drawingDraft');
                        setTimeout(() => window.close(), 1000);
                        return;
                    }
                }

                let success = false;

                if (window.opener && !window.opener.closed && typeof window.opener.handleDrawData === 'function') {
                    try {
                        window.opener.handleDrawData(data);
                        success = true;
                    } catch (e) {
                        console.warn('window.opener call failed:', e);
                    }
                }

                if (!success) {
                    try {
                        localStorage.setItem('drawnData', JSON.stringify(data));
                        success = true;
                    } catch (e) {
                        console.error('localStorage fallback failed:', e);
                        showToast('فشل الحفظ: ' + e.message, 'error');
                        return;
                    }
                }

                if (success) {
                    localStorage.removeItem('drawingDraft');
                    showToast('تم إرسال الرسم. يرجى الضغط على "إضافة منطقة" في الشاشة الرئيسية');
                    setTimeout(() => window.close(), 2000);
                } else {
                    showToast('تعذر الاتصال بالصفحة الرئيسية.', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ أثناء الحفظ: ' + e.message, 'error');
            }
        };

        document.getElementById('cancelBtn').onclick = () => window.close();

        function toggleMapType() {
            if (map.hasLayer(googleLayer)) {
                map.removeLayer(googleLayer);
                map.addLayer(hybridLayer);
                localStorage.setItem('preferredMapType', 'hybrid');
                showToast('تم التبديل إلى خريطة هجينة (مع عناوين)', 'info');
            } else {
                map.removeLayer(hybridLayer);
                map.addLayer(googleLayer);
                localStorage.setItem('preferredMapType', 'google');
                showToast('تم التبديل إلى خريطة قمر صناعي (بدون عناوين)', 'info');
            }
        }

        function initMap() {
            map = L.map('map').setView(DEFAULT_CENTER, 13);

            // Define Layers
            // Google Satellite (No Labels)
            googleLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });

            // Google Hybrid (With Labels)
            hybridLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });

            // Default to Google Satellite (No Labels) or saved preference
            const savedType = localStorage.getItem('preferredMapType');
            if (savedType === 'hybrid') {
                hybridLayer.addTo(map);
            } else {
                googleLayer.addTo(map);
            }

            map.on('click', onMapClick);
            map.on('mouseup', saveDraft);
            map.on('click', () => setTimeout(saveDraft, 100));

            // Add event listener for toggle button
            const toggleBtn = document.getElementById('toggleMapTypeBtn');
            if (toggleBtn) {
                toggleBtn.onclick = toggleMapType;
            }

            loadSettings();
            loadExistingAreas();
            populateAreaSelect();
            loadDraft();
        }

        initMap();

        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.4s ease-in forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function loadSettings() {
            const savedLineColor = localStorage.getItem('draw_lineColor');
            if (savedLineColor) {
                currentLineColor = savedLineColor;
                document.getElementById('lineColor').value = savedLineColor;
                document.getElementById('lineColorPreview').style.backgroundColor = savedLineColor;
            }

            const savedFillColor = localStorage.getItem('draw_fillColor');
            if (savedFillColor) {
                currentFillColor = savedFillColor;
                document.getElementById('fillColor').value = savedFillColor;
                document.getElementById('fillColorPreview').style.backgroundColor = savedFillColor;
            }

            const savedLineWidth = localStorage.getItem('draw_lineWidth');
            if (savedLineWidth) {
                currentLineWidth = parseInt(savedLineWidth);
                document.getElementById('lineWidth').value = currentLineWidth;
                document.getElementById('lineWidthValue').textContent = currentLineWidth + ' px';
            }
        }

        // Save settings on change
        document.getElementById('lineColor').addEventListener('change', (e) => localStorage.setItem('draw_lineColor', e.target.value));
        document.getElementById('fillColor').addEventListener('change', (e) => localStorage.setItem('draw_fillColor', e.target.value));
        document.getElementById('lineWidth').addEventListener('change', (e) => localStorage.setItem('draw_lineWidth', e.target.value));
    </script>
</body>

</html>