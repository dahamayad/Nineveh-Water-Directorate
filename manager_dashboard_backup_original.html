<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Copied and adapted styles from index.html */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4facfe;
            --secondary: #00f2fe;
            --accent: #ff0080;
            --dark-bg: #0f172a;
            /* Solid background for popup */
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --success: #00e676;
            --warning: #ffea00;
            --danger: #ff1744;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
            height: 100vh;
            overflow-y: auto;
            direction: rtl;
            padding: 20px;
        }

        /* Form Styles */
        .controls h3,
        .schedules-list h4 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            color: var(--text-muted);
            margin-bottom: 6px;
            font-size: 0.9rem;
            display: block;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        select option {
            background-color: #1e293b;
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #2980b9);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00b894);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff5252);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            width: auto;
        }

        /* Stats */
        .quick-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Lists */
        .schedule-item {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.05));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-right: 4px solid var(--primary);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(79, 172, 254, 0.2);
        }

        .schedule-item.completed {
            border-right-color: var(--success);
        }

        .schedule-item.in-progress {
            border-right-color: var(--warning);
        }

        .schedule-item.pending {
            border-right-color: var(--danger);
        }

        /* Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 4000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e293b;
            padding: 30px;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid var(--glass-border);
            color: white;
        }

        .close {
            position: absolute;
            left: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close:hover {
            color: white;
        }

        /* Form Grid Layout */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .form-grid .form-group {
            margin-bottom: 0;
        }

        /* Make textarea span full width if needed, or just let it be */
        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notification Bell */
        .btn-bell {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .btn-bell:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .bell-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--warning);
            opacity: 0;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* Notification Modal Styles */
        .notification-center {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .nc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .nc-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--secondary);
        }

        .nc-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 10px;
        }

        .nc-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            color: var(--text-muted);
        }

        .nc-tab.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .notif-type-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .notif-type-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .notif-type-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notif-type-card input {
            display: none;
        }

        .notif-type-card i {
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        /* Specific styles for Start Distribution (Blue) */
        #typeStartCard.selected {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.3);
        }

        #typeStartCard.selected i {
            color: var(--primary);
        }

        /* Specific styles for End Distribution (Red) */
        #typeEndCard.selected {
            background: rgba(255, 23, 68, 0.2);
            border-color: var(--danger);
            box-shadow: 0 0 15px rgba(255, 23, 68, 0.3);
        }

        #typeEndCard.selected i {
            color: var(--danger);
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
        }

        .checkbox-pill {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .checkbox-pill:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-pill input {
            width: auto;
            margin: 0;
        }

        /* Specific styles for Emergency (Red/Orange) */
        #typeEmergencyCard.selected {
            background: rgba(255, 82, 82, 0.2);
            border-color: var(--danger);
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.3);
        }

        .nc-history-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-right: 3px solid var(--text-muted);
        }

        .nc-history-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .nc-history-body {
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .btn-delete-notif {
            background: #fee2e2;
            color: #ef4444;
            border: none;

            const STORAGE_KEYS= {
                employees: 'waterEmployees',
                    areas: 'waterAreas',
                    schedules: 'waterSchedules'
            }

            ;

            let employees=[];
            let areas=[];
            let schedules=[];

            // Load Data
            function loadData() {
                employees=JSON.parse(localStorage.getItem(STORAGE_KEYS.employees)) || [];
                areas=JSON.parse(localStorage.getItem(STORAGE_KEYS.areas)) || [];
                schedules=JSON.parse(localStorage.getItem(STORAGE_KEYS.schedules)) || [];
                updateUI();
            }

            // Persist Data
            function persistAll() {
                localStorage.setItem(STORAGE_KEYS.employees, JSON.stringify(employees));
                localStorage.setItem(STORAGE_KEYS.areas, JSON.stringify(areas));
                localStorage.setItem(STORAGE_KEYS.schedules, JSON.stringify(schedules));

                // Notify main window to refresh
                if (window.opener && window.opener.refreshMapMarkers) {
                    window.opener.refreshMapMarkers();
                }
            }

            // UI Updates
            function updateUI() {
                document.getElementById('totalEmployees').textContent=employees.length;
                document.getElementById('totalAreas').textContent=areas.length;
                document.getElementById('totalSchedules').textContent=schedules.length;

                updateEmployeeList();
                updateScheduleList();
                updateSelects();
            }

            function updateSelects() {
                const areaSelect=document.getElementById('scheduleArea');
                const empSelect=document.getElementById('scheduleEmployee');

                const currentArea=areaSelect.value;
                const currentEmp=empSelect.value;

                areaSelect.innerHTML='<option value="">اختر المنطقة</option>';

                areas.forEach(a=> {
                        const opt=document.createElement('option');
                        opt.value=a.id;
                        opt.textContent=a.name;
                        if (a.id==currentArea) opt.selected=true;
                        areaSelect.appendChild(opt);
                    });

                empSelect.innerHTML='<option value="">اختر الموظف</option>';

                employees.forEach(e=> {
                        const opt=document.createElement('option');
                        opt.value=e.id;
                        opt.textContent=e.name;
                        if (e.id==currentEmp) opt.selected=true;
                        empSelect.appendChild(opt);
                    });
            }

            function updateEmployeeList() {
                const container=document.getElementById('employeesContainer');
                const search=document.getElementById('employeeSearch').value.toLowerCase();
                container.innerHTML='';

                employees.forEach(emp=> {
                        if (emp.name.toLowerCase().includes(search) || emp.phone.includes(search)) {
                            const div=document.createElement('div');
                            div.className='schedule-item';
                            div.style.borderRight='4px solid var(--primary)';

                            div.innerHTML=` <div style="display:flex;justify-content:space-between;align-items:center;" > <strong style="color:white;" >$ {
                                emp.name
                            }

                            </strong> <div style="display:flex;gap:5px;" > <button onclick="openEmployeeEditor(${emp.id})" class="btn btn-small btn-primary" style="margin:0;padding:4px 8px;" ><i class="fas fa-edit" ></i></button> </div> </div> <div style="color:#aaa;font-size:0.9rem;margin-top:5px;" > <i class="fas fa-phone" ></i> $ {
                                emp.phone
                            }

                            </div> `;
                            container.appendChild(div);
                        }
                    });
            }

            function updateScheduleList() {
                const container=document.getElementById('managerSchedulesContainer');
                if ( !container) return;
                container.innerHTML='';

                // Group schedules by area to show unique areas with their assigned employees
                const areaEmployeeMap=new Map();

                schedules.forEach(sch=> {
                        if ( !areaEmployeeMap.has(sch.areaId)) {
                            areaEmployeeMap.set(sch.areaId, new Set());
                        }

                        areaEmployeeMap.get(sch.areaId).add(sch.employeeId);
                    });

                // Define gradient colors for cards
                const gradients=[ 'linear-gradient(135deg, rgba(79, 172, 254, 0.15), rgba(0, 242, 254, 0.1))',
                'linear-gradient(135deg, rgba(0, 230, 118, 0.15), rgba(0, 184, 148, 0.1))',
                'linear-gradient(135deg, rgba(255, 234, 0, 0.15), rgba(255, 193, 7, 0.1))',
                'linear-gradient(135deg, rgba(255, 0, 128, 0.15), rgba(156, 39, 176, 0.1))',
                'linear-gradient(135deg, rgba(255, 87, 34, 0.15), rgba(244, 67, 54, 0.1))'
                ];

                // Display each area with its assigned employees
                let colorIndex=0;

                areas.forEach(area=> {
                        const employeeIds=areaEmployeeMap.get(area.id);
                        if ( !employeeIds || employeeIds.size===0) return;

                        const bgGradient=gradients[colorIndex % gradients.length];
                        colorIndex++;

                        const div=document.createElement('div');
                        div.className='schedule-item';
                        div.style.background=bgGradient;
                        div.style.borderRight='none'; // Remove default border for area cards

                        let employeesHTML='';

                        employeeIds.forEach(empId=> {
                                const employee=employees.find(e=> e.id===empId);
                                const sch=schedules.find(s=> s.areaId===area.id && s.employeeId===empId);

                                if (employee && sch) {
                                    let statusIcon='<i class="far fa-clock" style="color:#aaa;"></i>';
                                    let statusText='قيد الانتظار';
                                    let statusColor='#aaa';

                                    if (sch.status==='completed') {
                                        statusIcon='<i class="fas fa-check-circle" style="color:var(--success);"></i>';
                                        statusText='مكتمل';
                                        statusColor='var(--success)';
                                    }

                                    else if (sch.status==='in-progress') {
                                        statusIcon='<i class="fas fa-spinner fa-spin" style="color:var(--warning);"></i>';
                                        statusText='قيد التنفيذ';
                                        statusColor='var(--warning)';
                                    }

                                    // Schedule Details (Date, Time, Duration) - Always show if available
                                    let scheduleDetailsHTML='';

                                    if (sch.date || sch.startTime) {
                                        scheduleDetailsHTML=` <div style="margin-top:4px;font-size:0.8rem;color:#ddd;display:flex;gap:8px;flex-wrap:wrap;" > $ {
                                            sch.date ? `<span><i class="far fa-calendar" ></i> $ {
                                                sch.date
                                            }

                                            </span>` : ''
                                        }

                                        $ {
                                            sch.startTime ? `<span><i class="far fa-clock" ></i> $ {
                                                sch.startTime
                                            }

                                            - $ {
                                                sch.endTime || '?'
                                            }

                                            </span>` : ''
                                        }

                                        $ {
                                            sch.duration ? `<span><i class="fas fa-hourglass-half" ></i> $ {
                                                sch.duration
                                            }

                                            س</span>` : ''
                                        }

                                        </div> `;
                                    }

                                    employeesHTML +=` <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:8px;margin-bottom:8px;" > <div style="display:flex;justify-content:space-between;align-items:center;" > <strong style="color:white;" >$ {
                                        employee.name
                                    }

                                    </strong> <span style="font-size:0.8rem;color:${statusColor};" > $ {
                                        statusIcon
                                    }

                                    $ {
                                        statusText
                                    }

                                    </span> </div> $ {
                                        scheduleDetailsHTML
                                    }

                                    <div style="margin-top:6px;text-align:left;" > <button onclick="deleteSchedule(${sch.id})" class="btn btn-small btn-danger" style="margin:0;padding:2px 8px;font-size:0.7rem;width:auto;display:inline-block;" > <i class="fas fa-times" ></i> إلغاء </button> </div> </div> `;
                                }
                            });

                        div.innerHTML=` <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;" > <h4 style="margin:0;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.5);" >$ {
                            area.name
                        }

                        </h4> <div style="display:flex;gap:5px;" > <button onclick="editAreaCard(${area.id})" class="btn btn-small btn-primary" style="margin:0;padding:4px 8px;" ><i class="fas fa-edit" ></i></button> <button onclick="deleteAreaCard(${area.id})" class="btn btn-small btn-danger" style="margin:0;padding:4px 8px;" ><i class="fas fa-trash" ></i></button> </div> </div> $ {
                            employeesHTML
                        }

                        `;
                        container.appendChild(div);
                    });
            }

            // Event Listeners
            document.getElementById('addEmployee').onclick=()=> {
                const name=document.getElementById('employeeName').value.trim();
                const phone=document.getElementById('employeePhone').value.trim();

                if ( !name || !phone) return showToast('يرجى إدخال الاسم ورقم الهاتف', 'danger');

                employees.push({
                    id: Date.now(),
                    name,
                    phone
                });

            document.getElementById('employeeName').value='';
            document.getElementById('employeePhone').value='';
            persistAll();
            updateUI();
            showToast('تم إضافة الموظف بنجاح');
        }

        ;

        document.getElementById('addArea').onclick=()=> {
            const name=document.getElementById('areaName').value.trim();
            const desc=document.getElementById('areaDescription').value.trim();
            const x=document.getElementById('areaCoordX').value;
            const y=document.getElementById('areaCoordY').value;

            if ( !name) return showToast('يرجى إدخال اسم المنطقة', 'danger');

            const newArea= {
                id: Date.now(),
                    name,
                    description: desc,
                    lat: y ? parseFloat(y): null,
                    lng: x ? parseFloat(x): null,
                    geojson: window.drawnGeoJSON || null
            }

            ;

            areas.push(newArea);
            document.getElementById('areaName').value='';
            document.getElementById('areaDescription').value='';
            document.getElementById('areaCoordX').value='';
            document.getElementById('areaCoordY').value='';
            window.drawnGeoJSON=null;

            persistAll();
            updateUI();
            showToast('تم إضافة المنطقة بنجاح');
        }

        ;

        document.getElementById('addSchedule').onclick=()=> {
            const areaId=Number(document.getElementById('scheduleArea').value);
            const empId=Number(document.getElementById('scheduleEmployee').value);

            if ( !areaId || !empId) return showToast('يرجى اختيار المنطقة والموظف', 'danger');

            schedules.push({
                id: Date.now(),
                areaId,
                employeeId: empId,
                date: '',
                startTime: '',
                duration: 4,
                status: 'pending'
            });

        persistAll();
        updateUI();
        showToast('تم تعيين المنطقة للموظف بنجاح');
        }

        ;

        document.getElementById('openDrawAreaBtn').onclick=()=> {
            // Open draw_map.html in a new window
            const drawWindow=window.open('draw_map.html', 'drawMap', 'width=1200,height=800');

            if (drawWindow) {
                showToast('تم فتح نافذة الرسم');
            }

            else {
                showToast('فشل فتح نافذة الرسم. يرجى السماح بالنوافذ المنبثقة', 'danger');
            }
        }

        ;

        // Helpers
        function showToast(msg, type='success') {
            const toast=document.createElement('div');
            toast.className='notification-toast';
            toast.style.background=type==='danger' ? 'var(--danger)': 'var(--success)';
            toast.textContent=msg;
            document.body.appendChild(toast);
            setTimeout(()=> toast.remove(), 3000);
        }

        window.deleteEmployee=(id)=> {
            if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                employees=employees.filter(e=> e.id !==id);
                persistAll();
                updateUI();
            }
        }

        ;

        window.deleteSchedule=(id)=> {
            if (confirm('هل أنت متأكد من حذف هذا الجدول؟')) {
                schedules=schedules.filter(s=> s.id !==id);
                persistAll();
                updateUI();
            }
        }

        ;

        // Area card actions
        window.editAreaCard=(areaId)=> {
            const area=areas.find(a=> a.id===areaId);
            if ( !area) return;

            document.getElementById('scheduleArea').value=areaId;

            areaEditorSelect.innerHTML='<option value="">اختر المنطقة لتعديلها</option>';

            areas.forEach(a=> {
                    const opt=document.createElement('option');
                    opt.value=a.id;
                    opt.textContent=a.name;
                    if (a.id===areaId) opt.selected=true;
                    areaEditorSelect.appendChild(opt);
                });

            areaEditorName.value=area.name;
            areaEditorDesc.value=area.description || '';
            populateAreaEditorEmployees(areaId);
            areaEditorModal.style.display='flex';
        }

        ;

        window.deleteAreaCard=(areaId)=> {
            const area=areas.find(a=> a.id===areaId);
            if ( !area) return;

            if (confirm(`هل أنت متأكد من حذف منطقة "${area.name}" ؟ سيتم حذف جميع التعيينات المرتبطة بها.`)) {
                areas=areas.filter(a=> a.id !==areaId);
                schedules=schedules.filter(s=> s.areaId !==areaId);
                persistAll();
                updateUI();
                showToast('تم حذف المنطقة بنجاح');
            }
        }

        ;

        window.updateCoordinates=(lat, lng, geojson)=> {
            document.getElementById('areaCoordX').value=lng;
            document.getElementById('areaCoordY').value=lat;
            window.drawnGeoJSON=geojson;
            showToast('تم استلام الإحداثيات من الخريطة');
        }

        ;

        // Area Editor Logic
        const areaEditorModal=document.getElementById('areaEditorModal');
        const areaEditorSelect=document.getElementById('areaEditorSelect');
        const areaEditorName=document.getElementById('areaEditorName');
        const areaEditorDesc=document.getElementById('areaEditorDesc');
        const areaEditorEmployee=document.getElementById('areaEditorEmployee');

        function populateAreaEditorEmployees(areaId) {
            areaEditorEmployee.innerHTML='<option value="">اختر الموظف</option>';

            // Get currently assigned employee for this area (only one)
            const assignedSchedule=schedules.find(s=> s.areaId===areaId);
            const assignedEmployeeId=assignedSchedule ? assignedSchedule.employeeId: null;

            // Populate all employees
            employees.forEach(emp=> {
                    const opt=document.createElement('option');
                    opt.value=emp.id;
                    opt.textContent=emp.name;

                    if (emp.id===assignedEmployeeId) {
                        opt.selected=true;
                    }

                    areaEditorEmployee.appendChild(opt);
                });
        }

        document.getElementById('openAreaEditorBtn').onclick=()=> {
            const selectedAreaId=document.getElementById('scheduleArea').value;
            if ( !selectedAreaId) return showToast('يرجى اختيار منطقة أولاً', 'danger');

            areaEditorSelect.innerHTML='<option value="">اختر المنطقة لتعديلها</option>';

            areas.forEach(a=> {
                    const opt=document.createElement('option');
                    opt.value=a.id;
                    opt.textContent=a.name;
                    if (a.id==selectedAreaId) opt.selected=true;
                    areaEditorSelect.appendChild(opt);
                });

            const area=areas.find(a=> a.id==selectedAreaId);

            if (area) {
                areaEditorName.value=area.name;
                areaEditorDesc.value=area.description || '';
                populateAreaEditorEmployees(Number(selectedAreaId));
            }

            areaEditorModal.style.display='flex';
        }

        ;

        document.getElementById('closeAreaEditorModal').onclick=()=> {
            areaEditorModal.style.display='none';
        }

        ;

        window.onclick=(event)=> {
            if (event.target==areaEditorModal) {
                areaEditorModal.style.display='none';
            }

            if (event.target==employeeEditorModal) {
                employeeEditorModal.style.display='none';
            }
        }

        ;

        areaEditorSelect.onchange=()=> {
            const id=areaEditorSelect.value;
            if ( !id) return;
            const area=areas.find(a=> a.id==id);

            if (area) {
                areaEditorName.value=area.name;
                areaEditorDesc.value=area.description || '';
                populateAreaEditorEmployees(Number(id));
            }
        }

        ;

        document.getElementById('saveAreaEditBtn').onclick=()=> {
            const id=areaEditorSelect.value;
            if ( !id) return showToast('يرجى اختيار منطقة', 'danger');

            const name=areaEditorName.value.trim();
            const desc=areaEditorDesc.value.trim();
            const selectedEmployeeId=Number(areaEditorEmployee.value);

            if ( !name) return showToast('يرجى إدخال اسم المنطقة', 'danger');

            const areaIndex=areas.findIndex(a=> a.id==id);

            if (areaIndex !==-1) {
                areas[areaIndex].name=name;
                areas[areaIndex].description=desc;

                // Update employee assignment
                // Remove old assignments for this area
                schedules=schedules.filter(s=> s.areaId !=id);

                // Add new assignment if employee is selected
                if (selectedEmployeeId) {
                    schedules.push({
                        id: Date.now(),
                        areaId: Number(id),
                        employeeId: selectedEmployeeId,
                        date: '',
                        startTime: '',
                        duration: 4,
                        status: 'pending'
                    });
            }

            persistAll();
            updateUI();
            showToast('تم تحديث المنطقة بنجاح');
            areaEditorModal.style.display='none';
        }
        }

        ;

        document.getElementById('deleteAreaBtn').onclick=()=> {
            const id=areaEditorSelect.value;
            if ( !id) return showToast('يرجى اختيار منطقة', 'danger');

            if (confirm('هل أنت متأكد من حذف هذه المنطقة؟ سيتم حذف جميع الجداول المرتبطة بها.')) {
                areas=areas.filter(a=> a.id !=id);
                schedules=schedules.filter(s=> s.areaId !=id);
                persistAll();
                updateUI();
                showToast('تم حذف المنطقة بنجاح');
                areaEditorModal.style.display='none';
            }
        }

        ;

        // Employee Editor Logic
        const employeeEditorModal=document.getElementById('employeeEditorModal');
        const employeeEditorName=document.getElementById('employeeEditorName');
        const employeeEditorPhone=document.getElementById('employeeEditorPhone');
        const employeeEditorId=document.getElementById('employeeEditorId');

        window.openEmployeeEditor=(id)=> {
            const emp=employees.find(e=> e.id===id);
            if ( !emp) return;
            employeeEditorId.value=emp.id;
            employeeEditorName.value=emp.name;
            employeeEditorPhone.value=emp.phone;
            employeeEditorModal.style.display='flex';
        }

        ;

        document.getElementById('closeEmployeeEditorModal').onclick=()=> {
            employeeEditorModal.style.display='none';
        }

        ;

        document.getElementById('saveEmployeeEditBtn').onclick=()=> {
            const id=Number(employeeEditorId.value);
            const name=employeeEditorName.value.trim();
            const phone=employeeEditorPhone.value.trim();

            if ( !name || !phone) return showToast('يرجى ملء جميع الحقول', 'danger');

            const index=employees.findIndex(e=> e.id===id);

            if (index !==-1) {
                employees[index].name=name;
                employees[index].phone=phone;
                persistAll();
                updateUI();
                showToast('تم تحديث بيانات الموظف');
                employeeEditorModal.style.display='none';
            }
        }

        ;

        document.getElementById('deleteEmployeeBtn').onclick=()=> {
            const id=Number(employeeEditorId.value);

            if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                employees=employees.filter(e=> e.id !==id);
                persistAll();
                updateUI();
                showToast('تم حذف الموظف');
                employeeEditorModal.style.display='none';
            }
        }

        ;

        // Notification Logic
        function attachNotificationHandlers() {
            const headerBtn=document.getElementById('headerBroadcastBtn');
            const modal=document.getElementById('notificationModal');
            const close=document.getElementById('closeNotificationModal');
            const select=document.getElementById('notifyScheduleSelect');
            const msg=document.getElementById('notificationMessage');
            const send=document.getElementById('confirmSend');
            const tabs=document.querySelectorAll('.nc-tab');
            const typeRadios=document.querySelectorAll('input[name="notifType"]');

            const openModal=()=> {
                modal.style.display='flex';
                populateNotificationSchedules();
                populateNotificationHistory();
            }

            ;

            if (headerBtn) headerBtn.onclick=openModal;
            if (close) close.onclick=()=>modal.style.display='none';

            // Tab Switching
            tabs.forEach(tab=> {
                    tab.onclick=()=> {
                        tabs.forEach(t=> t.classList.remove('active'));
                        tab.classList.add('active');

                        if (tab.dataset.tab==='new') {
                            document.getElementById('ncTabNew').style.display='block';
                            document.getElementById('ncTabHistory').style.display='none';
                        }

                        else {
                            document.getElementById('ncTabNew').style.display='none';
                            document.getElementById('ncTabHistory').style.display='block';
                            populateNotificationHistory();
                        }
                    }

                    ;
                });

            const updateMessage=()=> {
                const scheduleId=Number(select.value);
                const schedule=schedules.find(s=> s.id===scheduleId);
                const type=document.querySelector('input[name="notifType"]:checked').value;

                // Update card selection visual
                document.querySelectorAll('.notif-type-card').forEach(c=> c.classList.remove('selected'));
                if (type==='start') document.getElementById('typeStartCard').classList.add('selected');
                else if (type==='end') document.getElementById('typeEndCard').classList.add('selected');
                else if (type==='emergency') document.getElementById('typeEmergencyCard').classList.add('selected');

                if (schedule) {
                    const area=areas.find(a=> a.id===schedule.areaId);

                    if (area) {
                        if (type==='start') {
                            msg.value=`تنويه: بدء توزيع المياه في $ {
                                area.name
                            }

                            \nوقت البدء: $ {
                                schedule.startTime || 'الآن'
                            }

                            \nمدة التجهيز: $ {
                                schedule.duration
                            }

                            ساعة`;
                        }

                        else if (type==='end') {
                            msg.value=`تنويه: انتهاء توزيع المياه في $ {
                                area.name
                            }

                            \nشكراً لتعاونكم.`;
                        }

                        else {
                            msg.value=`تنويه هام: توقف ضخ المياه في $ {
                                area.name
                            }

                            بسبب أعمال صيانة طارئة.\nنعتذر عن الإزعاج.`;
                        }
                    }
                }

                else {
                    if (type==='emergency') {
                        msg.value=`تنويه هام: توقف ضخ المياه بسبب أعمال صيانة طارئة أو انقطاع التيار الكهربائي.\nنعتذر عن الإزعاج.`;
                    }

                    else {
                        msg.value='';
                    }
                }
            }

            ;

            if (select) select.onchange=updateMessage;
            typeRadios.forEach(radio=> radio.onchange=updateMessage);

            if (send) send.onclick=()=> {
                if ( !msg.value.trim()) {
                    showToast('الرجاء إدخال نص الإشعار', 'danger');
                    return;
                }

                const durationHours=Number(document.getElementById('notificationDuration').value) || 24;
                const expiresAt=Date.now()+(durationHours * 60 * 60 * 1000);

                const notification= {
                    id: Date.now(),
                        message: msg.value,
                        timestamp: new Date().getTime(),
                        expiresAt: expiresAt,
                        read: false
                }

                ;

                const existing=JSON.parse(localStorage.getItem('waterNotifications') || '[]');
                existing.push(notification);
                localStorage.setItem('waterNotifications', JSON.stringify(existing));

                showToast('تم إرسال الإشعار بنجاح');
                modal.style.display='none';

                // Notify opener if exists
                if (window.opener && window.opener.checkForNotifications) {
                    window.opener.checkForNotifications();
                }
            }

            ;

            // Close modal when clicking outside
            window.addEventListener('click', (e)=> {
                    if (e.target===modal) {
                        modal.style.display='none';
                    }
                });
        }

        function populateNotificationSchedules() {
            const select=document.getElementById('notifyScheduleSelect');
            select.innerHTML='<option value="">-- اختر منطقة التوزيع --</option>';

            schedules.forEach(sch=> {
                    const area=areas.find(a=> a.id===sch.areaId);
                    const emp=employees.find(e=> e.id===sch.employeeId);

                    if (area) {
                        const opt=document.createElement('option');
                        opt.value=sch.id;

                        opt.textContent=`$ {
                            area.name
                        }

                        - $ {
                            sch.date || ''
                        }

                        ($ {
                                emp ? emp.name : 'غير محدد'
                            })`;
                        select.appendChild(opt);
                    }
                });
        }

        function populateNotificationHistory() {
            const list=document.getElementById('notificationHistoryList');
            const raw=localStorage.getItem('waterNotifications');
            let notifs=raw ? JSON.parse(raw): [];

            // Filter out expired notifications
            const now=Date.now();
            const validNotifs=notifs.filter(n=> !n.expiresAt || n.expiresAt > now);

            // Update storage if items were removed
            if (validNotifs.length !==notifs.length) {
                localStorage.setItem('waterNotifications', JSON.stringify(validNotifs));
                notifs=validNotifs;
            }

            if (notifs.length===0) {
                list.innerHTML='<p style="text-align:center;color:#999;">لا يوجد سجل إشعارات</p>';
                return;
            }

            list.innerHTML='';

            notifs.slice().reverse().forEach(n=> {
                    const date=new Date(n.timestamp).toLocaleString('ar-SA');
                    let expiryText='';

                    if (n.expiresAt) {
                        const expiryDate=new Date(n.expiresAt).toLocaleString('ar-SA');

                        expiryText=`<div style="font-size:0.75rem;color:#94a3b8;margin-top:5px;" ><i class="fas fa-hourglass-end" ></i> ينتهي في: $ {
                            expiryDate
                        }

                        </div>`;
                    }

                    const item=document.createElement('div');
                    item.className='nc-history-item';

                    item.innerHTML=` <div class="nc-history-header" style="display:flex;justify-content:space-between;align-items:center;" > <span><i class="far fa-clock" ></i> $ {
                        date
                    }

                    </span> <button onclick="deleteNotification(${n.id})" class="btn-delete-notif" title="حذف الإشعار" > <i class="fas fa-trash-alt" ></i> </button> </div> <div class="nc-history-body" > $ {
                        n.message
                    }

                    $ {
                        expiryText
                    }

                    </div> `;
                    list.appendChild(item);
                });
        }

        window.deleteNotification=function (id) {
            if ( !confirm('هل أنت متأكد من حذف هذا الإشعار؟')) return;

            const raw=localStorage.getItem('waterNotifications');
            let notifs=raw ? JSON.parse(raw): [];
            notifs=notifs.filter(n=> n.id !==id);
            localStorage.setItem('waterNotifications', JSON.stringify(notifs));

            populateNotificationHistory();
            showToast('تم حذف الإشعار بنجاح');
        }

        ;

        // Init
        document.getElementById('employeeSearch').addEventListener('input', updateEmployeeList);

        window.addEventListener('storage', (e)=> {
                if (Object.values(STORAGE_KEYS).includes(e.key)) {
                    loadData();
                }
            });

        loadData();
        attachNotificationHandlers();
        // Manager Back Button Logic
        const managerBackBtn=document.getElementById('managerBackBtn');

        if (managerBackBtn) {
            managerBackBtn.addEventListener('click', ()=> {
                    if (confirm('هل تريد الرجوع للشاشة الرئيسية؟')) {

                        // If opened via window.open, close it. Otherwise, go to index.html
                        if (window.opener) {
                            window.close();
                        }

                        else {
                            window.location.href='index.html';
                        }
                    }
                });
        }

        </script></body></html>