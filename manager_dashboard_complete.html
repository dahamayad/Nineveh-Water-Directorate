</div>
<div id="ncTabHistory" style="display:none;">
    <div id="notificationHistoryList" style="max-height: 300px; overflow-y: auto;"></div>
</div>
</div>
</div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal">
    <div class="modal-content" style="max-width: 420px; text-align: center; padding: 35px;">
        <div style="margin-bottom: 25px;">
            <i class="fas fa-sign-out-alt"
                style="font-size: 4.5rem; color: var(--primary); opacity: 0.9; animation: pulse 2s infinite;"></i>
        </div>
        <h3 style="margin-bottom: 15px; font-size: 1.6rem; color: white;">تأكيد المغادرة</h3>
        <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 1.05rem; line-height: 1.6;">
            هل أنت متأكد من رغبتك في الرجوع للشاشة الرئيسية؟<br>
            <span style="font-size: 0.9rem; opacity: 0.8;">سيتم حفظ جميع التغييرات تلقائياً</span>
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="confirmLogoutBtn" class="btn btn-primary"
                style="width: auto; min-width: 130px; padding: 14px 24px;">
                <i class="fas fa-check-circle"></i> نعم، الرجوع
            </button>
            <button id="cancelLogoutBtn" class="btn btn-secondary"
                style="width: auto; min-width: 130px; padding: 14px 24px;">
                <i class="fas fa-times-circle"></i> إلغاء
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }
</style>

<script>
    const STORAGE_KEYS = {
        employees: 'waterEmployees',
        areas: 'waterAreas',
        schedules: 'waterSchedules'
    };

    let employees = [];
    let areas = [];
    let schedules = [];

    function loadData() {
        employees = JSON.parse(localStorage.getItem(STORAGE_KEYS.employees)) || [];
        areas = JSON.parse(localStorage.getItem(STORAGE_KEYS.areas)) || [];
        schedules = JSON.parse(localStorage.getItem(STORAGE_KEYS.schedules)) || [];
        updateUI();
    }

    function persistAll() {
        localStorage.setItem(STORAGE_KEYS.employees, JSON.stringify(employees));
        localStorage.setItem(STORAGE_KEYS.areas, JSON.stringify(areas));
        localStorage.setItem(STORAGE_KEYS.schedules, JSON.stringify(schedules));
        if (window.opener && window.opener.refreshMapMarkers) {
            window.opener.refreshMapMarkers();
        }
    }

    function updateUI() {
        document.getElementById('totalEmployees').textContent = employees.length;
        document.getElementById('totalAreas').textContent = areas.length;
        document.getElementById('totalSchedules').textContent = schedules.length;
        updateEmployeeList();
        updateScheduleList();
        updateSelects();
    }

    function updateSelects() {
        const areaSelect = document.getElementById('scheduleArea');
        const empSelect = document.getElementById('scheduleEmployee');
        const currentArea = areaSelect.value;
        const currentEmp = empSelect.value;

        areaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
        areas.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name;
            if (a.id == currentArea) opt.selected = true;
            areaSelect.appendChild(opt);
        });

        empSelect.innerHTML = '<option value="">اختر الموظف</option>';
        employees.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            if (e.id == currentEmp) opt.selected = true;
            empSelect.appendChild(opt);
        });
    }

    function updateEmployeeList() {
        const container = document.getElementById('employeesContainer');
        const search = document.getElementById('employeeSearch').value.toLowerCase();
        container.innerHTML = '';

        employees.forEach(emp => {
            if (emp.name.toLowerCase().includes(search) || emp.phone.includes(search)) {
                const div = document.createElement('div');
                div.className = 'schedule-item';
                div.style.borderRight = '4px solid var(--primary)';
                div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="color:white;">${emp.name}</strong>
                        <div style="display:flex;gap:5px;">
                            <button onclick="openEmployeeEditor(${emp.id})" class="btn btn-small btn-primary" style="margin:0;padding:4px 8px;"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                    <div style="color:#aaa;font-size:0.9rem;margin-top:5px;">
                        <i class="fas fa-phone"></i> ${emp.phone}
                    </div>`;
                container.appendChild(div);
            }
        });
    }

    function updateScheduleList() {
        const container = document.getElementById('managerSchedulesContainer');
        if (!container) return;
        container.innerHTML = '';

        const areaEmployeeMap = new Map();
        schedules.forEach(sch => {
            if (!areaEmployeeMap.has(sch.areaId)) {
                areaEmployeeMap.set(sch.areaId, new Set());
            }
            areaEmployeeMap.get(sch.areaId).add(sch.employeeId);
        });

        const gradients = [
            'linear-gradient(135deg, rgba(79, 172, 254, 0.15), rgba(0, 242, 254, 0.1))',
            'linear-gradient(135deg, rgba(0, 230, 118, 0.15), rgba(0, 184, 148, 0.1))',
            'linear-gradient(135deg, rgba(255, 234, 0, 0.15), rgba(255, 193, 7, 0.1))',
            'linear-gradient(135deg, rgba(255, 0, 128, 0.15), rgba(156, 39, 176, 0.1))',
            'linear-gradient(135deg, rgba(255, 87, 34, 0.15), rgba(244, 67, 54, 0.1))'
        ];

        let colorIndex = 0;
        areas.forEach(area => {
            const employeeIds = areaEmployeeMap.get(area.id);
            if (!employeeIds || employeeIds.size === 0) return;

            const bgGradient = gradients[colorIndex % gradients.length];
            colorIndex++;

            const div = document.createElement('div');
            div.className = 'schedule-item';
            div.style.background = bgGradient;
            div.style.borderRight = 'none';

            let employeesHTML = '';
            employeeIds.forEach(empId => {
                const employee = employees.find(e => e.id === empId);
                const sch = schedules.find(s => s.areaId === area.id && s.employeeId === empId);

                if (employee && sch) {
                    let statusIcon = '<i class="far fa-clock" style="color:#aaa;"></i>';
                    let statusText = 'قيد الانتظار';
                    let statusColor = '#aaa';

                    if (sch.status === 'completed') {
                        statusIcon = '<i class="fas fa-check-circle" style="color:var(--success);"></i>';
                        statusText = 'مكتمل';
                        statusColor = 'var(--success)';
                    } else if (sch.status === 'in-progress') {
                        statusIcon = '<i class="fas fa-spinner fa-spin" style="color:var(--warning);"></i>';
                        statusText = 'قيد التنفيذ';
                        statusColor = 'var(--warning)';
                    }

                    let scheduleDetailsHTML = '';
                    if (sch.date || sch.startTime) {
                        scheduleDetailsHTML = `<div style="margin-top:4px;font-size:0.8rem;color:#ddd;display:flex;gap:8px;flex-wrap:wrap;">
                                ${sch.date ? `<span><i class="far fa-calendar"></i> ${sch.date}</span>` : ''}
                                ${sch.startTime ? `<span><i class="far fa-clock"></i> ${sch.startTime} - ${sch.endTime || '?'}</span>` : ''}
                                ${sch.duration ? `<span><i class="fas fa-hourglass-half"></i> ${sch.duration}س</span>` : ''}
                            </div>`;
                    }

                    employeesHTML += `<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong style="color:white;">${employee.name}</strong>
                                <span style="font-size:0.8rem;color:${statusColor};">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>
                            ${scheduleDetailsHTML}
                            <div style="margin-top:6px;text-align:left;">
                                <button onclick="deleteSchedule(${sch.id})" class="btn btn-small btn-danger" style="margin:0;padding:2px 8px;font-size:0.7rem;width:auto;display:inline-block;">
                                    <i class="fas fa-times"></i> إلغاء
                                </button>
                            </div>
                        </div>`;
                }
            });

            div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h4 style="margin:0;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.5);">${area.name}</h4>
                    <div style="display:flex;gap:5px;">
                        <button onclick="editAreaCard(${area.id})" class="btn btn-small btn-primary" style="margin:0;padding:4px 8px;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteAreaCard(${area.id})" class="btn btn-small btn-danger" style="margin:0;padding:4px 8px;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${employeesHTML}`;
            container.appendChild(div);
        });
    }

    document.getElementById('addEmployee').onclick = () => {
        const name = document.getElementById('employeeName').value.trim();
        const phone = document.getElementById('employeePhone').value.trim();
        if (!name || !phone) return showToast('يرجى إدخال الاسم ورقم الهاتف', 'danger');

        employees.push({ id: Date.now(), name, phone });
        document.getElementById('employeeName').value = '';
        document.getElementById('employeePhone').value = '';
        persistAll();
        updateUI();
        showToast('تم إضافة الموظف بنجاح');
    };

    document.getElementById('addArea').onclick = () => {
        const name = document.getElementById('areaName').value.trim();
        const desc = document.getElementById('areaDescription').value.trim();
        const x = document.getElementById('areaCoordX').value;
        const y = document.getElementById('areaCoordY').value;
        if (!name) return showToast('يرجى إدخال اسم المنطقة', 'danger');

        const newArea = {
            id: Date.now(),
            name,
            description: desc,
            lat: y ? parseFloat(y) : null,
            lng: x ? parseFloat(x) : null,
            geojson: window.drawnGeoJSON || null
        };

        areas.push(newArea);
        document.getElementById('areaName').value = '';
        document.getElementById('areaDescription').value = '';
        document.getElementById('areaCoordX').value = '';
        document.getElementById('areaCoordY').value = '';
        window.drawnGeoJSON = null;
        persistAll();
        updateUI();
        showToast('تم إضافة المنطقة بنجاح');
    };

    document.getElementById('addSchedule').onclick = () => {
        const areaId = Number(document.getElementById('scheduleArea').value);
        const empId = Number(document.getElementById('scheduleEmployee').value);
        if (!areaId || !empId) return showToast('يرجى اختيار المنطقة والموظف', 'danger');

        schedules.push({
            id: Date.now(),
            areaId,
            employeeId: empId,
            date: '',
            startTime: '',
            duration: 4,
            status: 'pending'
        });

        persistAll();
        updateUI();
        showToast('تم تعيين المنطقة للموظف بنجاح');
    };

    document.getElementById('openDrawAreaBtn').onclick = () => {
        const drawWindow = window.open('draw_map.html', 'drawMap', 'width=1200,height=800');
        if (drawWindow) {
            showToast('تم فتح نافذة الرسم');
        } else {
            showToast('فشل فتح نافذة الرسم. يرجى السماح بالنوافذ المنبثقة', 'danger');
        }
    };

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.style.background = type === 'danger' ? 'var(--danger)' : 'var(--success)';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    window.deleteEmployee = (id) => {
        if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
            employees = employees.filter(e => e.id !== id);
            persistAll();
            updateUI();
        }
    };

    window.deleteSchedule = (id) => {
        if (confirm('هل أنت متأكد من حذف هذا الجدول؟')) {
            schedules = schedules.filter(s => s.id !== id);
            persistAll();
            updateUI();
        }
    };

    window.editAreaCard = (areaId) => {
        const area = areas.find(a => a.id === areaId);
        if (!area) return;

        document.getElementById('scheduleArea').value = areaId;
        areaEditorSelect.innerHTML = '<option value="">اختر المنطقة لتعديلها</option>';
        areas.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name;
            if (a.id === areaId) opt.selected = true;
            areaEditorSelect.appendChild(opt);
        });

        areaEditorName.value = area.name;
        areaEditorDesc.value = area.description || '';
        populateAreaEditorEmployees(areaId);
        areaEditorModal.style.display = 'flex';
    };

    window.deleteAreaCard = (areaId) => {
        const area = areas.find(a => a.id === areaId);
        if (!area) return;

        if (confirm(`هل أنت متأكد من حذف منطقة "${area.name}" ؟ سيتم حذف جميع التعيينات المرتبطة بها.`)) {
            areas = areas.filter(a => a.id !== areaId);
            schedules = schedules.filter(s => s.areaId !== areaId);
            persistAll();
            updateUI();
            showToast('تم حذف المنطقة بنجاح');
        }
    };

    window.updateCoordinates = (lat, lng, geojson) => {
        document.getElementById('areaCoordX').value = lng;
        document.getElementById('areaCoordY').value = lat;
        window.drawnGeoJSON = geojson;
        showToast('تم استلام الإحداثيات من الخريطة');
    };

    const areaEditorModal = document.getElementById('areaEditorModal');
    const areaEditorSelect = document.getElementById('areaEditorSelect');
    const areaEditorName = document.getElementById('areaEditorName');
    const areaEditorDesc = document.getElementById('areaEditorDesc');
    const areaEditorEmployee = document.getElementById('areaEditorEmployee');

    function populateAreaEditorEmployees(areaId) {
        areaEditorEmployee.innerHTML = '<option value="">اختر الموظف</option>';
        const assignedSchedule = schedules.find(s => s.areaId === areaId);
        const assignedEmployeeId = assignedSchedule ? assignedSchedule.employeeId : null;

        employees.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.id;
            opt.textContent = emp.name;
            if (emp.id === assignedEmployeeId) {
                opt.selected = true;
            }
            areaEditorEmployee.appendChild(opt);
        });
    }

    document.getElementById('openAreaEditorBtn').onclick = () => {
        const selectedAreaId = document.getElementById('scheduleArea').value;
        if (!selectedAreaId) return showToast('يرجى اختيار منطقة أولاً', 'danger');

        areaEditorSelect.innerHTML = '<option value="">اختر المنطقة لتعديلها</option>';
        areas.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name;
            if (a.id == selectedAreaId) opt.selected = true;
            areaEditorSelect.appendChild(opt);
        });

        const area = areas.find(a => a.id == selectedAreaId);
        if (area) {
            areaEditorName.value = area.name;
            areaEditorDesc.value = area.description || '';
            populateAreaEditorEmployees(Number(selectedAreaId));
        }
        areaEditorModal.style.display = 'flex';
    };

    document.getElementById('closeAreaEditorModal').onclick = () => {
        areaEditorModal.style.display = 'none';
    };

    window.onclick = (event) => {
        if (event.target == areaEditorModal) {
            areaEditorModal.style.display = 'none';
        }
        if (event.target == employeeEditorModal) {
            employeeEditorModal.style.display = 'none';
        }
    };

    areaEditorSelect.onchange = () => {
        const id = areaEditorSelect.value;
        if (!id) return;
        const area = areas.find(a => a.id == id);

        if (area) {
            areaEditorName.value = area.name;
            areaEditorDesc.value = area.description || '';
            populateAreaEditorEmployees(Number(id));
        }
    };

    document.getElementById('saveAreaEditBtn').onclick = () => {
        const id = areaEditorSelect.value;
        if (!id) return showToast('يرجى اختيار منطقة', 'danger');

        const name = areaEditorName.value.trim();
        const desc = areaEditorDesc.value.trim();
        const selectedEmployeeId = Number(areaEditorEmployee.value);

        if (!name) return showToast('يرجى إدخال اسم المنطقة', 'danger');

        const areaIndex = areas.findIndex(a => a.id == id);

        if (areaIndex !== -1) {
            areas[areaIndex].name = name;
            areas[areaIndex].description = desc;

            schedules = schedules.filter(s => s.areaId != id);

            if (selectedEmployeeId) {
                schedules.push({
                    id: Date.now(),
                    areaId: Number(id),
                    employeeId: selectedEmployeeId,
                    date: '',
                    startTime: '',
                    duration: 4,
                    status: 'pending'
                });
            }

            persistAll();
            updateUI();
            showToast('تم تحديث المنطقة بنجاح');
            areaEditorModal.style.display = 'none';
        }
    };

    document.getElementById('deleteAreaBtn').onclick = () => {
        const id = areaEditorSelect.value;
        if (!id) return showToast('يرجى اختيار منطقة', 'danger');

        if (confirm('هل أنت متأكد من حذف هذه المنطقة؟ سيتم حذف جميع الجداول المرتبطة بها.')) {
            areas = areas.filter(a => a.id != id);
            schedules = schedules.filter(s => s.areaId != id);
            persistAll();
            updateUI();
            showToast('تم حذف المنطقة بنجاح');
            areaEditorModal.style.display = 'none';
        }
    };

    const employeeEditorModal = document.getElementById('employeeEditorModal');
    const employeeEditorName = document.getElementById('employeeEditorName');
    const employeeEditorPhone = document.getElementById('employeeEditorPhone');
    const employeeEditorId = document.getElementById('employeeEditorId');

    window.openEmployeeEditor = (id) => {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        employeeEditorId.value = emp.id;
        employeeEditorName.value = emp.name;
        employeeEditorPhone.value = emp.phone;
        employeeEditorModal.style.display = 'flex';
    };

    document.getElementById('closeEmployeeEditorModal').onclick = () => {
        employeeEditorModal.style.display = 'none';
    };

    document.getElementById('saveEmployeeEditBtn').onclick = () => {
        const id = Number(employeeEditorId.value);
        const name = employeeEditorName.value.trim();
        const phone = employeeEditorPhone.value.trim();

        if (!name || !phone) return showToast('يرجى ملء جميع الحقول', 'danger');

        const index = employees.findIndex(e => e.id === id);

        if (index !== -1) {
            employees[index].name = name;
            employees[index].phone = phone;
            persistAll();
            updateUI();
            showToast('تم تحديث بيانات الموظف');
            employeeEditorModal.style.display = 'none';
        }
    };

    document.getElementById('deleteEmployeeBtn').onclick = () => {
        const id = Number(employeeEditorId.value);

        if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
            employees = employees.filter(e => e.id !== id);
            persistAll();
            updateUI();
            showToast('تم حذف الموظف');
            employeeEditorModal.style.display = 'none';
        }
    };

    function attachNotificationHandlers() {
        const headerBtn = document.getElementById('headerBroadcastBtn');
        const modal = document.getElementById('notificationModal');
        const close = document.getElementById('closeNotificationModal');
        const select = document.getElementById('notifyScheduleSelect');
        const msg = document.getElementById('notificationMessage');
        const send = document.getElementById('confirmSend');
        const tabs = document.querySelectorAll('.nc-tab');
        const typeRadios = document.querySelectorAll('input[name="notifType"]');

        const openModal = () => {
            modal.style.display = 'flex';
            populateNotificationSchedules();
            populateNotificationHistory();
        };

        if (headerBtn) headerBtn.onclick = openModal;
        if (close) close.onclick = () => modal.style.display = 'none';

        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                if (tab.dataset.tab === 'new') {
                    document.getElementById('ncTabNew').style.display = 'block';
                    document.getElementById('ncTabHistory').style.display = 'none';
                } else {
                    document.getElementById('ncTabNew').style.display = 'none';
                    document.getElementById('ncTabHistory').style.display = 'block';
                    populateNotificationHistory();
                }
            };
        });

        const updateMessage = () => {
            const scheduleId = Number(select.value);
            const schedule = schedules.find(s => s.id === scheduleId);
            const type = document.querySelector('input[name="notifType"]:checked').value;

            document.querySelectorAll('.notif-type-card').forEach(c => c.classList.remove('selected'));
            if (type === 'start') document.getElementById('typeStartCard').classList.add('selected');
            else if (type === 'end') document.getElementById('typeEndCard').classList.add('selected');
            else if (type === 'emergency') document.getElementById('typeEmergencyCard').classList.add('selected');

            if (schedule) {
                const area = areas.find(a => a.id === schedule.areaId);

                if (area) {
                    if (type === 'start') {
                        msg.value = `تنويه: بدء توزيع المياه في ${area.name}\n\nوقت البدء: ${schedule.startTime || 'الآن'}\n\nمدة التجهيز: ${schedule.duration}\n\nساعة`;
                    } else if (type === 'end') {
                        msg.value = `تنويه: انتهاء توزيع المياه في ${area.name}\n\nشكراً لتعاونكم.`;
                    } else {
                        msg.value = `تنويه هام: توقف ضخ المياه في ${area.name}\n\nبسبب أعمال صيانة طارئة.\nنعتذر عن الإزعاج.`;
                    }
                }
            } else {
                if (type === 'emergency') {
                    msg.value = `تنويه هام: توقف ضخ المياه بسبب أعمال صيانة طارئة أو انقطاع التيار الكهربائي.\nنعتذر عن الإزعاج.`;
                } else {
                    msg.value = '';
                }
            }
        };

        if (select) select.onchange = updateMessage;
        typeRadios.forEach(radio => radio.onchange = updateMessage);

        if (send) send.onclick = () => {
            if (!msg.value.trim()) {
                showToast('الرجاء إدخال نص الإشعار', 'danger');
                return;
            }

            const durationHours = Number(document.getElementById('notificationDuration').value) || 24;
            const expiresAt = Date.now() + (durationHours * 60 * 60 * 1000);

            const notification = {
                id: Date.now(),
                message: msg.value,
                timestamp: new Date().getTime(),
                expiresAt: expiresAt,
                read: false
            };

            const existing = JSON.parse(localStorage.getItem('waterNotifications') || '[]');
            existing.push(notification);
            localStorage.setItem('waterNotifications', JSON.stringify(existing));

            showToast('تم إرسال الإشعار بنجاح');
            modal.style.display = 'none';

            if (window.opener && window.opener.checkForNotifications) {
                window.opener.checkForNotifications();
            }
        };

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    function populateNotificationSchedules() {
        const select = document.getElementById('notifyScheduleSelect');
        select.innerHTML = '<option value="">-- اختر منطقة التوزيع --</option>';

        schedules.forEach(sch => {
            const area = areas.find(a => a.id === sch.areaId);
            const emp = employees.find(e => e.id === sch.employeeId);

            if (area) {
                const opt = document.createElement('option');
                opt.value = sch.id;
                opt.textContent = `${area.name} - ${sch.date || ''} (${emp ? emp.name : 'غير محدد'})`;
                select.appendChild(opt);
            }
        });
    }

    function populateNotificationHistory() {
        const list = document.getElementById('notificationHistoryList');
        const raw = localStorage.getItem('waterNotifications');
        let notifs = raw ? JSON.parse(raw) : [];

        const now = Date.now();
        const validNotifs = notifs.filter(n => !n.expiresAt || n.expiresAt > now);

        if (validNotifs.length !== notifs.length) {
            localStorage.setItem('waterNotifications', JSON.stringify(validNotifs));
            notifs = validNotifs;
        }

        if (notifs.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:#999;">لا يوجد سجل إشعارات</p>';
            return;
        }

        list.innerHTML = '';

        notifs.slice().reverse().forEach(n => {
            const date = new Date(n.timestamp).toLocaleString('ar-SA');
            let expiryText = '';

            if (n.expiresAt) {
                const expiryDate = new Date(n.expiresAt).toLocaleString('ar-SA');
                expiryText = `<div style="font-size:0.75rem;color:#94a3b8;margin-top:5px;"><i class="fas fa-hourglass-end"></i> ينتهي في: ${expiryDate}</div>`;
            }

            const item = document.createElement('div');
            item.className = 'nc-history-item';

            item.innerHTML = `<div class="nc-history-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <span><i class="far fa-clock"></i> ${date}</span>
                    <button onclick="deleteNotification(${n.id})" class="btn-delete-notif" title="حذف الإشعار">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="nc-history-body">
                    ${n.message}
                    ${expiryText}
                </div>`;
            list.appendChild(item);
        });
    }

    window.deleteNotification = function (id) {
        if (!confirm('هل أنت متأكد من حذف هذا الإشعار؟')) return;

        const raw = localStorage.getItem('waterNotifications');
        let notifs = raw ? JSON.parse(raw) : [];
        notifs = notifs.filter(n => n.id !== id);
        localStorage.setItem('waterNotifications', JSON.stringify(notifs));

        populateNotificationHistory();
        showToast('تم حذف الإشعار بنجاح');
    };

    // Logout Modal Logic
    const managerBackBtn = document.getElementById('managerBackBtn');
    const logoutModal = document.getElementById('logoutModal');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

    if (managerBackBtn) {
        managerBackBtn.addEventListener('click', () => {
            logoutModal.style.display = 'flex';
        });
    }

    if (cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener('click', () => {
            logoutModal.style.display = 'none';
        });
    }

    if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', () => {
            if (window.opener) {
                window.close();
            } else {
                window.location.href = 'index.html';
            }
        });
    }

    window.addEventListener('click', (e) => {
        if (e.target === logoutModal) {
            logoutModal.style.display = 'none';
        }
    });

    document.getElementById('employeeSearch').addEventListener('input', updateEmployeeList);

    loadData();
    attachNotificationHandlers();
</script>
</body>

</html>